<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XLOOKUP Merge Tool</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- SheetJS for Excel/CSV parsing -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <!-- FileSaver for exporting files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body>
<div class="container my-5">
    <h2 class="mb-4 text-center">XLOOKUP Merge Tool</h2>

    <!-- Progress Bar -->
    <div id="progressContainer" class="progress mb-3" style="height: 25px; display: none;">
        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
    </div>

    <div class="row mb-3">
        <div class="col-md-6">
            <label for="file1" class="form-label">Upload File 1</label>
            <input type="file" id="file1" class="form-control" accept=".xlsx,.xls,.csv">
        </div>
        <div class="col-md-6">
            <label for="file2" class="form-label">Upload File 2</label>
            <input type="file" id="file2" class="form-control" accept=".xlsx,.xls,.csv">
        </div>
    </div>

    <div id="options" class="card p-4 mb-4" style="display:none;">
        <div class="row g-3">
            <div class="col-md-4">
                <label for="key1" class="form-label">Key Column (File 1)</label>
                <select id="key1" class="form-select"></select>
            </div>
            <div class="col-md-4">
                <label for="key2" class="form-label">Key Column (File 2)</label>
                <select id="key2" class="form-select"></select>
            </div>
            <div class="col-md-4 d-flex align-items-end">
                <button id="loadColumns" class="btn btn-primary w-100">Load Columns</button>
            </div>
        </div>
        <div id="columnSelectors" style="display:none;" class="mt-4">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Select Columns to Retain (File 1)</label>
                    <div id="cols1Container"></div>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Select Columns to Retain (File 2)</label>
                    <div id="cols2Container"></div>
                </div>
            </div>
            <div class="row mt-4">
                <div class="col">
                    <button id="mergeBtn" class="btn btn-success">Merge &amp; Show Result</button>
                </div>
                <div class="col text-end">
                    <button id="exportCsv" class="btn btn-outline-secondary me-2" disabled>Export CSV</button>
                    <button id="exportXlsx" class="btn btn-outline-secondary" disabled>Export Excel</button>
                </div>
            </div>
        </div>
    </div>

    <div id="result"></div>
</div>

<script>
let data1 = [], data2 = [], headers1 = [], headers2 = [];
let currentResult = [];
let mergeWorker;

// Initialize Web Worker for merging
function initWorker() {
    const code = `self.onmessage = function(e) {
        const { data1, data2, key1, key2, cols1, cols2 } = e.data;
        const map2 = new Map(data2.map(r => [r[key2], r]));
        const result = data1.map(r1 => {
            const r2 = map2.get(r1[key1]) || {};
            const out = {};
            cols1.forEach(c => out[c] = r1[c]);
            cols2.forEach(c => out[c] = r2[c] || '');
            return out;
        });
        postMessage(result);
    };`;
    const blob = new Blob([code], { type: 'application/javascript' });
    mergeWorker = new Worker(URL.createObjectURL(blob));
    mergeWorker.onerror = e => { console.error('Worker error:', e.message); alert('An error occurred during merging.'); hideProgress(); };
    mergeWorker.onmessage = e => {
        currentResult = e.data;
        displayResult(currentResult);
        hideProgress();
        document.getElementById('exportCsv').disabled = false;
        document.getElementById('exportXlsx').disabled = false;
    };
}
initWorker();

function showProgress() { document.getElementById('progressContainer').style.display = 'block'; }
function hideProgress() {
    const container = document.getElementById('progressContainer');
    const bar = document.getElementById('progressBar');
    container.style.display = 'none'; bar.style.width = '0%';
}

// Populate select for key columns
function populateSelect(id, items) {
    document.getElementById(id).innerHTML = items.map(i => `<option value="${i}">${i}</option>`).join('');
}

// Populate checkboxes for column retention
function populateCheckboxes(containerId, items) {
    const container = document.getElementById(containerId);
    container.innerHTML = items.map(item => `
        <div class="form-check">
            <input class="form-check-input" type="checkbox" value="${item}" id="${containerId}-${item}">
            <label class="form-check-label" for="${containerId}-${item}">${item}</label>
        </div>
    `).join('');
}

// Read file: unified parsing
function readFile(fileInput, callback) {
    const file = fileInput.files[0];
    const reader = new FileReader();
    const isCSV = file.name.toLowerCase().endsWith('.csv');
    reader.onload = e => {
        try {
            let wb;
            if (isCSV) wb = XLSX.read(e.target.result, { type: 'string' });
            else wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
            const sheet = wb.Sheets[wb.SheetNames[0]];
            callback(XLSX.utils.sheet_to_json(sheet, { defval: '' }));
        } catch (err) { console.error(err); alert('Failed to parse ' + file.name); }
    };
    isCSV ? reader.readAsText(file) : reader.readAsArrayBuffer(file);
}

// Monitor file inputs
['file1','file2'].forEach(id => document.getElementById(id).addEventListener('change', () => {
    const f1 = document.getElementById('file1').files[0];
    const f2 = document.getElementById('file2').files[0];
    if (f1 && f2) {
        let loaded = 0;
        readFile(document.getElementById('file1'), json => { data1 = json; headers1 = Object.keys(json[0]||{}); populateSelect('key1', headers1); populateCheckboxes('cols1Container', headers1); if (++loaded===2) document.getElementById('options').style.display='block'; });
        readFile(document.getElementById('file2'), json => { data2 = json; headers2 = Object.keys(json[0]||{}); populateSelect('key2', headers2); populateCheckboxes('cols2Container', headers2); if (++loaded===2) document.getElementById('options').style.display='block'; });
    }
}));

document.getElementById('loadColumns').onclick = () => document.getElementById('columnSelectors').style.display = 'block';

document.getElementById('mergeBtn').onclick = () => {
    const key1 = document.getElementById('key1').value;
    const key2 = document.getElementById('key2').value;
    let cols1 = Array.from(document.querySelectorAll('#cols1Container input:checked')).map(cb => cb.value);
    let cols2 = Array.from(document.querySelectorAll('#cols2Container input:checked')).map(cb => cb.value);
    if (!cols1.length) cols1 = [...headers1];
    if (!cols2.length) cols2 = [...headers2];
    showProgress();
    mergeWorker.postMessage({ data1, data2, key1, key2, cols1, cols2 });
};

function displayResult(data) {
    const con = document.getElementById('result');
    if (!data.length) return con.innerHTML = '<p>No results.</p>';
    const cols = Object.keys(data[0]);
    let html = '<table class="table table-striped"><thead><tr>' + cols.map(c=>`<th>${c}</th>`).join('') + '</tr></thead><tbody>';
    data.forEach(r=> html+='<tr>'+cols.map(c=>`<td>${r[c]}</td>`).join('')+'</tr>');
    html+='</tbody></table>';
    con.innerHTML = html;
}

// Export
function exportSheet(type) {
    const ws = XLSX.utils.json_to_sheet(currentResult);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Result');
    const data = type==='csv'? XLSX.utils.sheet_to_csv(ws): XLSX.write(wb,{bookType:'xlsx',type:'array'});
    saveAs(new Blob([data]), `merge_result.${type==='csv'?'csv':'xlsx'}`);
}

['exportCsv','exportXlsx'].forEach(id=> document.getElementById(id).onclick=()=>exportSheet(id==='exportCsv'?'csv':'xlsx'));
</script>
</body>
</html>
